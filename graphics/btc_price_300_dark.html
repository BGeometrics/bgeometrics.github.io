<!DOCTYPE html>
<html>

<head>
    <title>Bitcoin Price</title>
</head>

<body>
    <link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/stocktools/gui.css">
    <link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/annotations/popup.css">
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/price-indicator.js"></script>
    <script src="https://code.highcharts.com/modules/full-screen.js"></script>
    <script src="https://code.highcharts.com/stock/modules/heikinashi.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/themes/brand-dark.js"></script>
    <style>
        :root {
            --highcharts-neutral-color-3: #000000;
        }

        .highcharts-contextbutton .highcharts-button-symbol {
            stroke: #000000 !important; 
            fill: #000000 !important; 
        }

        .highcharts-menu-item { 
            background-color: #000000 !important; 
            color: #FFFFFF !important; 
        }   

        .highcharts-menu {
            background-color: #000000 !important; 
            border: 1px solid #ccc !important;
            color: #dddddd !important; 
        }
    </style>

    <div id="container-iframe" style="width:100%; height:300px; margin: 0 auto;"></div>

    <script>
        (async () => {
            const data_price = await fetch(
                'https://charts.bgeometrics.com/files/realized_price_btc_price.json'
            ).then(response => response.json());
            const data_ohlc = await fetch(
                'https://charts.bgeometrics.com/files/btc_ohlc_4h.json'
            ).then(response => response.json());
            const data_ohlc_1h = await fetch(
                'https://charts.bgeometrics.com/files/btc_ohlc_1h.json'
            ).then(response => response.json());

            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const cutoffTimestamp = oneYearAgo.getTime();

            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7); // ahora sí es hace una semana
            const cutoffTimestampWeek = oneWeekAgo.getTime();

            // Parte 1: data_price hasta hace un año
            const data_price_until_year = data_price.filter(item => item[0] < cutoffTimestamp);

            // Parte 2: data_ohlc entre hace un año y hace una semana (solo cierre)
            const data_ohlc_from_year = data_ohlc
                .filter(item => item[0] >= cutoffTimestamp && item[0] < cutoffTimestampWeek)
                .map(item => [item[0], item[4]]);

            // Parte 3: data_ohlc_1h desde hace una semana
            const data_ohlc_from_week = data_ohlc_1h
                .filter(item => item[0] >= cutoffTimestampWeek)
                .map(item => [item[0], item[4]]);

            // Unión final
            const data_ohlc_all_1h = data_price_until_year
                .concat(data_ohlc_from_year)
                .concat(data_ohlc_from_week);

            var close_prices = data_ohlc_all_1h.map(item => {
                if (item.length === 2) return [item[0], item[1]];
                return [item[0], item[4]];
            });

            var chart = Highcharts.stockChart('container-iframe', {
                navigator: {
                    enabled: false
                },

                scrollbar: {
                    enabled: false
                },

                chart: {
                    renderTo: 'container-iframe',
                },

                xAxis: {
                    visible: true,
                    min: cutoffTimestampWeek
                },

                yAxis: [{
                gridLineWidth: 0,
                    labels: {
                        enabled: false
                    },
                    title: {
                        text: null
                    },
                    visible: true,
                }],

                series: [
                    {
                        id: 'BTC price',
                        name: 'BTC price',
                        color: 'white',
                        data: close_prices,
                        tooltip: {
                            valuePrefix: '$',
                            valueDecimals: 2
                        },
                        yAxis: 0
                    },
                ],

                legend: {
                    enabled: false,
                },

                rangeSelector: {
                    enabled: true,
                    inputEnabled: false,
                    selected: 1,
                    buttons: [{
                        type: 'day',
                        count: 1,
                        text: '1d'
                    }, {
                        type: 'week',
                        count: 1,
                        text: '1w'
                    }, {
                        type: 'month',
                        count: 1,
                        text: '1m'
                    }, {
                        type: 'month',
                        count: 3,
                        text: '3m'
                    }, {
                        type: 'month',
                        count: 6,
                        text: '6m'
                    }, {
                        type: 'year',
                        count: 1,
                        text: '1y'
                    }, {
                        type: 'year',
                        count: 2,
                        text: '2y'
                    }, {
                        type: 'year',
                        count: 4,
                        text: '4y'
                    }, {
                        type: 'all',
                        text: 'All'
                    }]
                },

                credits: {
                    enabled: false,
                    visible: false,
                },

            });
        })();
    </script>

</body>

</html>